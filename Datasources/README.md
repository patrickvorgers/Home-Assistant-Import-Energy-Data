# Data preparation

Dedicated conversion scripts (python) exist for various energy providers to generate one or more CSV files in the required format.
If a specific script is not available for a given provider, the `TemplateDataPrepare.py` script can be used to generate the CSV files in the required format.
The template script works by filling in the necessary information about the structure of the input file.

**Note**:
- The CSV files produced by these scripts serve as input for the `ImportData.py` script, which imports the prepared data into a working temporary table (`IMPORT_DATA`) in the Home Assistant database.
- Ensure that the imported data precedes the sensor data in Home Assistant while still overlapping with the current data. It is not possible to import data for a sensor that is later than the data in Home Assistant or to fill in any gaps; such data will be ignored because the Home Assistant data takes precedence.


The following input dataformats are supported:
- CSV
- XLS/XLSX
- JSON
- SQLite database

Contributions of additional template scripts and sample data for unsupported energy providers are welcomed.

## CSV File format and naming conventions
Data is prepared to conform to a specific filename and content format:

### Filename format
The filename must include both the sensor identifier and the resolution.
The sensor identifier is used by the generic SQL script to map the data to the corresponding sensor defined in Home Assistant.

- Example: `elec_feed_in_tariff_1_high_resolution.csv`
    - **Sensor ID**: `elec_feed_in_tariff_1`
    - **Resolution**: `HIGH`

### Content format
Each CSV file must consist of exactly two fields per row:
- First field: Unix epoch timestamp of the sensor reading
- Second field: Sensor reading value

## Importing prepared data into Home Assistant

The `ImportData.py` script automates the process of loading sensor data into Home Assistant for further processing by the SQL script that populates the Home Assistant tables.
It accepts CSV files generated by the datasource scripts as input.

**Note:** Although the datapreparation scripts are primarily provided for energy-related data, the `ImportData.py` script is sensor-agnostic.
It can import sensor data for any sensor type, provided that the CSV files adhere to the specified format.
The SQL script that processes the imported data is also sensor-agnostic and can be used to process data for any sensor, as long as the sensor configuration within the SQL script is defined correctly.

### Functionality
- **Automatic Data Import**:<br>
  Reads sensor data from CSV files containing a timestamp and a sensor value.
- **Automatic sensor identification**:<br>
  Extracts sensor details based on the CSV filename. For example, a file named `elec_feed_in_tariff_1_high_resolution.csv` is interpreted as sensor data for the sensor with id: `sensor_id_elec_feed_in_tariff_1` with `HIGH` resolution data.
The id is used to identify the sensor in the SQL script that processes the imported data into the right Home Assistant tables.
- **Flexible file selection**:<br>
  Supports importing one or multiple CSV files, including the use of wildcard patterns (e.g., "data/*.csv") to process batches of files.
- **Database compatibility**:<br>
  Operates with both local SQLite databases and MariaDB servers.
- **Safe and repeatable import**:<br>
  Designed to handle repeated imports while keeping the data current. The data is imported into a "temporary" working table.

### Tooling
- MySQL python library ```pip install mysql-connector-python```
 
### Usage instructions
- **CSV file preparation**:<br>
  Generate CSV files using either the dedicated datasource scripts for a specific energy provider or the ``TemplateDataPrepare.py` script if no specific script exists.
Depending on the input file, multiple CSV files may be generated.
- **Database Selection**:<br>
    - For SQLite, specify the path to the SQLite database file.
    - For MariaDB, provide the database host, username, password, and database name.
- **Command-line execution**:<br>
  Execute the script from a command-line interface using the appropriate options.

  **Example for SQLite**:<br>
  ```python ImportData.py --db-type sqlite --sqlite-db mydb.db --csv-file "data\*.csv" --verbose```<br>
  **Example for MariaDB**:<br>
  ```python ImportData.py --db-type mariadb --host localhost --user root --database mydb --csv-file "data\*.csv" --verbose```<br>
- **Optional: Data Preservation**:<br>
  The `--suppress-recreate` option preserves the existing IMPORT_DATA table, allowing new data to be added without deleting previously imported data.